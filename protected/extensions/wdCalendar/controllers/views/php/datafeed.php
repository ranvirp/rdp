<?php//include_once("dbconfig.php");include_once("functions.php");function addCalendar($st, $et, $sub, $ade){  $ret = array();  try{    $event = new Events;	      $event->title=mysql_real_escape_string($sub);      $event->starttime=php2MySqlTime(js2PhpTime($st));      $event->endtime=php2MySqlTime(js2PhpTime($et));      $event->isalldayevent=mysql_real_escape_string($ade);    		if($event->save()==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = $event->error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = $event->id;    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  try{    $event = new Events;    $event->title=mysql_real_escape_string($sub);      $event->starttime=php2MySqlTime(js2PhpTime($st));      $event->endtime=php2MySqlTime(js2PhpTime($et));      $event->isalldayevent=mysql_real_escape_string($ade);$event->description=      mysql_real_escape_string($dscr);$event->location = mysql_real_escape_string($loc);$event->color= mysql_real_escape_string($color);		if($event->save()==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = $event->error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] = $event->id;    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function listCalendarByRange($sd, $ed){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  try{   $events = Events::model()->findAllByAttributes(array(),'starttime between :sd AND   :ed', array(':sd' => php2MySqlTime($sd),':ed' => php2MySqlTime($ed)));      //echo $sql;    foreach ($events as $event ) {           $ret['events'][] = array(        $event->id,        $event->title,        php2JsTime(mySql2PhpTime($event->starttime)),        php2JsTime(mySql2PhpTime($event->endtime)),        $event->isalldayevent,        0, //more than one day event        //$row->InstanceType,        0,//Recurring event,        $event->color,        1,//editable        $event->location,         ''//$attends      );    }	}catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type){  $phpTime = js2PhpTime($day);  //echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  //echo $st . "--" . $et;  return listCalendarByRange($st, $et);}function updateCalendar($id, $st, $et){  $ret = array();  try{    $event= Events::model()->findByPk($id);	$event->starttime=php2MySqlTime(js2PhpTime($st));	$event->endtime=php2MySqlTime(js2PhpTime($et));       //echo $sql;		if($event->save()==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = $event->error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz){  $ret = array();  try{    $event= Events::model()->findByPk($id);	 $event->title=mysql_real_escape_string($sub);      $event->starttime=php2MySqlTime(js2PhpTime($st));      $event->endtime=php2MySqlTime(js2PhpTime($et));      $event->isalldayevent=mysql_real_escape_string($ade);$event->description=      mysql_real_escape_string($dscr);$event->location = mysql_real_escape_string($loc);$event->color= mysql_real_escape_string($color);   		if($event->save()==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = $event->error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{   $event=Events::model()->findByPk($id);   $event->delete();    		if($event->save()==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = $event->error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Succefully';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $get["method"];switch ($method) {    case "add":        $ret = addCalendar($post["CalendarStartTime"], $post["CalendarEndTime"], $post["CalendarTitle"], $post["IsAllDayEvent"]);        break;    case "list":        $ret = listCalendar($post["showdate"], $post["viewtype"]);        break;    case "update":        $ret = updateCalendar($post["calendarId"], $post["CalendarStartTime"], $post["CalendarEndTime"]);        break;     case "remove":        $ret = removeCalendar( $post["calendarId"]);        break;    case "adddetails":        $st = $post["stpartdate"] . " " . $post["stparttime"];        $et = $post["etpartdate"] . " " . $post["etparttime"];        if(isset($get["id"])){            $ret = updateDetailedCalendar($get["id"], $st, $et,                 $post["Subject"], isset($post["IsAllDayEvent"])?1:0, $post["Description"],                 $post["Location"], $post["colorvalue"], $post["timezone"]);        }else{            $ret = addDetailedCalendar($st, $et,                                    $post["Subject"], isset($post["IsAllDayEvent"])?1:0, $post["Description"],                 $post["Location"], $post["colorvalue"], $post["timezone"]);        }                break; }echo json_encode($ret); ?>